name: Build macOS

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘æˆ–æ¨é€æ ‡ç­¾æ—¶
on:
  workflow_dispatch:
    inputs:
      architecture:
        description: 'Target architecture'
        required: true
        default: 'arm64'
        type: choice
        options:
        - arm64
        - x86_64
        - both
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    strategy:
      fail-fast: false
      matrix:
        include:
          - architecture: arm64
            runner: macos-14  # Apple Silicon
          - architecture: x86_64
            runner: macos-13  # Intel
    runs-on: ${{ matrix.runner }}
    if: ${{ github.event.inputs.architecture == matrix.architecture || github.event.inputs.architecture == 'both' || github.event_name == 'push' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          # å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
          brew install create-dmg

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install nuitka ordered-set
          pip install -r requirements.txt

      - name: Get version from config
        id: get_version
        run: |
          VERSION=$(python3 -c "from app.common.config import VERSION; print(VERSION)")
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Building version: ${VERSION}"

      - name: Create app icon (if not exists)
        run: |
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„åº”ç”¨å›¾æ ‡ï¼ˆå¦‚æœä¸å­˜åœ¨çš„è¯ï¼‰
          mkdir -p app/resource/images
          if [ ! -f "app/resource/images/logo.icns" ]; then
            echo "âš ï¸ Creating placeholder icon..."
            # åˆ›å»ºä¸€ä¸ªç®€å•çš„å›¾æ ‡å ä½ç¬¦
            sips -s format icns /System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/GenericApplicationIcon.icns --out app/resource/images/logo.icns
          fi

      - name: Build with Nuitka
        run: |
          echo "ğŸ”¨ Starting Nuitka build..."
          python3 -m nuitka \
            --standalone \
            --plugin-enable=pyqt5 \
            --include-qt-plugins=sensible,sqldrivers \
            --show-memory \
            --show-progress \
            --macos-create-app-bundle \
            --assume-yes-for-downloads \
            --macos-disable-console \
            --macos-app-version="${{ env.VERSION }}" \
            --macos-app-name="VidFlowDesktop" \
            --macos-app-icon="app/resource/images/logo.icns" \
            --copyright="${{ env.VERSION }} Mark" \
            --output-dir=dist \
            VidFlowDesktop.py
          
          echo "âœ… Nuitka build completed"

      - name: Set executable permissions
        run: |
          chmod u+x "dist/VidFlowDesktop.app/Contents/MacOS/VidFlowDesktop"
          echo "âœ… Executable permissions set"

      - name: Clean build artifacts
        run: |
          rm -rf "dist/VidFlowDesktop.build"
          echo "ğŸ§¹ Build artifacts cleaned"

      - name: Download FFmpeg for macOS
        run: |
          echo "ğŸ“¥ Downloading FFmpeg for macOS..."
          
          # åˆ›å»ºFFmpegç›®å½•
          mkdir -p "dist/VidFlowDesktop.app/Contents/MacOS/ffmpeg"
          
          # ä¸‹è½½FFmpegé™æ€æ„å»ºç‰ˆæœ¬
          if [ "${{ matrix.architecture }}" == "arm64" ]; then
            FFMPEG_URL="https://evermeet.cx/ffmpeg/getrelease/zip"
          else
            FFMPEG_URL="https://evermeet.cx/ffmpeg/getrelease/zip"
          fi
          
          # ä¸‹è½½å¹¶è§£å‹FFmpeg
          curl -L "$FFMPEG_URL" -o "/tmp/ffmpeg.zip"
          unzip -o "/tmp/ffmpeg.zip" -d "/tmp/ffmpeg_extract"
          
          # å¤åˆ¶FFmpegåˆ°åº”ç”¨åŒ…ä¸­
          cp "/tmp/ffmpeg_extract/ffmpeg" "dist/VidFlowDesktop.app/Contents/MacOS/ffmpeg/ffmpeg"
          chmod +x "dist/VidFlowDesktop.app/Contents/MacOS/ffmpeg/ffmpeg"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf "/tmp/ffmpeg.zip" "/tmp/ffmpeg_extract"
          
          echo "âœ… FFmpeg downloaded and installed"

      - name: Update FFmpeg path in app
        run: |
          echo "ğŸ”§ Updating FFmpeg path for macOS..."
          
          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„Pythonè„šæœ¬æ¥ä¿®æ”¹FFmpegè·¯å¾„
          cat > update_ffmpeg_path.py << 'EOF'
          import os
          import re
          
          # è¯»å–threadManager.pyæ–‡ä»¶
          thread_manager_path = "dist/VidFlowDesktop.app/Contents/MacOS/app/common/threadManager.py"
          
          if os.path.exists(thread_manager_path):
              with open(thread_manager_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # æ›¿æ¢FFmpegè·¯å¾„ä¸ºmacOSç‰ˆæœ¬
              # å°† 'ffmpeg.exe' æ›¿æ¢ä¸º 'ffmpeg'
              content = content.replace("'ffmpeg', 'ffmpeg.exe'", "'ffmpeg', 'ffmpeg'")
              content = content.replace('"ffmpeg", "ffmpeg.exe"', '"ffmpeg", "ffmpeg"')
              
              # å†™å›æ–‡ä»¶
              with open(thread_manager_path, 'w', encoding='utf-8') as f:
                  f.write(content)
              
              print("âœ… FFmpeg path updated for macOS")
          else:
              print("âš ï¸ threadManager.py not found in expected location")
          EOF
          
          python3 update_ffmpeg_path.py

      - name: Verify app structure
        run: |
          echo "ğŸ” Verifying app structure..."
          ls -la "dist/VidFlowDesktop.app/Contents/MacOS/"
          
          if [ -f "dist/VidFlowDesktop.app/Contents/MacOS/VidFlowDesktop" ]; then
            echo "âœ… Main executable found"
          else
            echo "âŒ Main executable not found"
            exit 1
          fi
          
          if [ -f "dist/VidFlowDesktop.app/Contents/MacOS/ffmpeg/ffmpeg" ]; then
            echo "âœ… FFmpeg found"
          else
            echo "âš ï¸ FFmpeg not found"
          fi

      - name: Create DMG installer
        run: |
          echo "ğŸ“¦ Creating DMG installer..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºDMGå†…å®¹
          mkdir -p dmg_temp
          
          # å¤åˆ¶åº”ç”¨åˆ°ä¸´æ—¶ç›®å½•
          cp -R "dist/VidFlowDesktop.app" dmg_temp/
          
          # åˆ›å»ºApplicationsé“¾æ¥
          ln -s /Applications dmg_temp/Applications
          
          # ä½¿ç”¨create-dmgåˆ›å»ºDMG
          create-dmg \
            --volname "VidFlowDesktop" \
            --volicon "app/resource/images/logo.icns" \
            --window-pos 200 120 \
            --window-size 800 450 \
            --icon-size 100 \
            --icon "VidFlowDesktop.app" 200 190 \
            --hide-extension "VidFlowDesktop.app" \
            --app-drop-link 600 185 \
            --hdiutil-quiet \
            "VidFlowDesktop-v${{ env.VERSION }}-macOS-${{ matrix.architecture }}.dmg" \
            dmg_temp/
          
          # å¦‚æœcreate-dmgå¤±è´¥ï¼Œä½¿ç”¨hdiutilä½œä¸ºå¤‡é€‰
          if [ ! -f "VidFlowDesktop-v${{ env.VERSION }}-macOS-${{ matrix.architecture }}.dmg" ]; then
            echo "âš ï¸ create-dmg failed, using hdiutil..."
            
            hdiutil create -srcfolder dmg_temp \
              -volname "VidFlowDesktop" \
              -fs HFS+ \
              -fsargs "-c c=64,a=16,e=16" \
              -format UDZO \
              -size 400m \
              "VidFlowDesktop-v${{ env.VERSION }}-macOS-${{ matrix.architecture }}.dmg"
          fi
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf dmg_temp
          
          echo "âœ… DMG created successfully"

      - name: Verify DMG
        run: |
          if [ -f "VidFlowDesktop-v${{ env.VERSION }}-macOS-${{ matrix.architecture }}.dmg" ]; then
            echo "âœ… DMG file created: VidFlowDesktop-v${{ env.VERSION }}-macOS-${{ matrix.architecture }}.dmg"
            ls -lh "VidFlowDesktop-v${{ env.VERSION }}-macOS-${{ matrix.architecture }}.dmg"
          else
            echo "âŒ DMG file not found"
            exit 1
          fi

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: VidFlowDesktop-v${{ env.VERSION }}-macOS-${{ matrix.architecture }}
          path: VidFlowDesktop-v${{ env.VERSION }}-macOS-${{ matrix.architecture }}.dmg
          retention-days: 30

  # åˆ›å»ºGitHub Releaseï¼ˆä»…åœ¨æ¨é€æ ‡ç­¾æ—¶ï¼‰
  create-release:
    needs: build-macos
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=$(echo ${GITHUB_REF#refs/tags/v})
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.VERSION }}
          release_name: VidFlowDesktop v${{ env.VERSION }}
          body: |
            ## VidFlowDesktop v${{ env.VERSION }} - macOSç‰ˆæœ¬
            
            ### ğŸ‰ æ–°åŠŸèƒ½
            - å¤šå¹³å°è§†é¢‘ä¸‹è½½æ”¯æŒ
            - æ”¯æŒæŠ–éŸ³ã€Bç«™ç­‰ä¸»æµå¹³å°
            - ç°ä»£åŒ–çš„Fluent Designç•Œé¢
            
            ### ğŸ“± macOSæ”¯æŒ
            - âœ… Apple Silicon (M1/M2/M3) åŸç”Ÿæ”¯æŒ
            - âœ… Intelå¤„ç†å™¨å…¼å®¹
            - âœ… macOS 10.15+ (Catalinaæˆ–æ›´é«˜ç‰ˆæœ¬)
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            - **Apple Silicon Mac**: ä¸‹è½½ `VidFlowDesktop-v${{ env.VERSION }}-macOS-arm64.dmg`
            - **Intel Mac**: ä¸‹è½½ `VidFlowDesktop-v${{ env.VERSION }}-macOS-x86_64.dmg`
            
            ### ğŸ› ï¸ å®‰è£…è¯´æ˜
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„DMGæ–‡ä»¶
            2. åŒå‡»DMGæ–‡ä»¶æ‰“å¼€
            3. å°†VidFlowDesktopæ‹–æ‹½åˆ°Applicationsæ–‡ä»¶å¤¹
            4. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸è¿è¡Œ
            
            ### âš ï¸ å®‰å…¨æç¤º
            å¦‚æœé‡åˆ°"åº”ç”¨å·²æŸå"çš„æç¤ºï¼Œè¯·åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œï¼š
            ```bash
            sudo xattr -rd com.apple.quarantine /Applications/VidFlowDesktop.app
            ```
            
            ---
            
            **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/v${{ env.VERSION }}...v${{ env.VERSION }}
          draft: false
          prerelease: false

      - name: Upload macOS ARM64 Release Asset
        if: hashFiles('artifacts/VidFlowDesktop-v*-macOS-arm64/*.dmg') != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/VidFlowDesktop-v${{ env.VERSION }}-macOS-arm64/VidFlowDesktop-v${{ env.VERSION }}-macOS-arm64.dmg
          asset_name: VidFlowDesktop-v${{ env.VERSION }}-macOS-arm64.dmg
          asset_content_type: application/x-apple-diskimage

      - name: Upload macOS x86_64 Release Asset
        if: hashFiles('artifacts/VidFlowDesktop-v*-macOS-x86_64/*.dmg') != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/VidFlowDesktop-v${{ env.VERSION }}-macOS-x86_64/VidFlowDesktop-v${{ env.VERSION }}-macOS-x86_64.dmg
          asset_name: VidFlowDesktop-v${{ env.VERSION }}-macOS-x86_64.dmg
          asset_content_type: application/x-apple-diskimage