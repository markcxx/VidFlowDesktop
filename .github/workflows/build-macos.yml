name: Build macOS

on:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install nuitka
          pip install -r requirements.txt

      - name: Get version
        run: |
          VERSION=$(python3 -c "from app.common.config import VERSION; print(VERSION)")
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Build with Nuitka
        run: |
          python3 deploy_macos.py

      - name: Download FFmpeg
        run: |
          # åˆ›å»ºFFmpegç›®å½•
          mkdir -p "dist/VidFlowDesktop.app/Contents/MacOS/ffmpeg"
          
          # ä¸‹è½½FFmpeg
          curl -L "https://evermeet.cx/ffmpeg/getrelease/zip" -o "/tmp/ffmpeg.zip"
          unzip -o "/tmp/ffmpeg.zip" -d "/tmp/ffmpeg_extract"
          
          # å¤åˆ¶FFmpegåˆ°åº”ç”¨åŒ…ä¸­
          cp "/tmp/ffmpeg_extract/ffmpeg" "dist/VidFlowDesktop.app/Contents/MacOS/ffmpeg/ffmpeg"
          chmod +x "dist/VidFlowDesktop.app/Contents/MacOS/ffmpeg/ffmpeg"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf "/tmp/ffmpeg.zip" "/tmp/ffmpeg_extract"

      - name: Create DMG
        run: |
          ln -s /Applications dist/Applications
          hdiutil create -srcfolder "dist/" -volname "VidFlowDesktop" -fs HFS+ -fsargs "-c c=64,a=16,e=16" -format UDZO -size 400m "VidFlowDesktop-v${{ env.VERSION }}-macOS-arm64.dmg"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VidFlowDesktop-v${{ env.VERSION }}-macOS-arm64
          path: VidFlowDesktop-v${{ env.VERSION }}-macOS-arm64.dmg

  # åˆ›å»ºGitHub Releaseï¼ˆä»…åœ¨æ¨é€æ ‡ç­¾æ—¶ï¼‰
  create-release:
    needs: build-macos
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=$(echo ${GITHUB_REF#refs/tags/v})
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.VERSION }}
          release_name: VidFlowDesktop v${{ env.VERSION }}
          body: |
            ## VidFlowDesktop v${{ env.VERSION }} - macOSç‰ˆæœ¬
            
            ### ğŸ‰ æ–°åŠŸèƒ½
            - å¤šå¹³å°è§†é¢‘ä¸‹è½½æ”¯æŒ
            - æ”¯æŒæŠ–éŸ³ã€Bç«™ç­‰ä¸»æµå¹³å°
            - ç°ä»£åŒ–çš„Fluent Designç•Œé¢
            
            ### ğŸ“± macOSæ”¯æŒ
            - âœ… Apple Silicon (M1/M2/M3) åŸç”Ÿæ”¯æŒ
            - âœ… Intelå¤„ç†å™¨å…¼å®¹
            - âœ… macOS 10.15+ (Catalinaæˆ–æ›´é«˜ç‰ˆæœ¬)
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            - **Apple Silicon Mac**: ä¸‹è½½ `VidFlowDesktop-v${{ env.VERSION }}-macOS-arm64.dmg`
            - **Intel Mac**: ä¸‹è½½ `VidFlowDesktop-v${{ env.VERSION }}-macOS-x86_64.dmg`
            
            ### ğŸ› ï¸ å®‰è£…è¯´æ˜
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„DMGæ–‡ä»¶
            2. åŒå‡»DMGæ–‡ä»¶æ‰“å¼€
            3. å°†VidFlowDesktopæ‹–æ‹½åˆ°Applicationsæ–‡ä»¶å¤¹
            4. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸è¿è¡Œ
            
            ### âš ï¸ å®‰å…¨æç¤º
            å¦‚æœé‡åˆ°"åº”ç”¨å·²æŸå"çš„æç¤ºï¼Œè¯·åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œï¼š
            ```bash
            sudo xattr -rd com.apple.quarantine /Applications/VidFlowDesktop.app
            ```
            
            ---
            
            **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/v${{ env.VERSION }}...v${{ env.VERSION }}
          draft: false
          prerelease: false

      - name: Upload macOS ARM64 Release Asset
        if: hashFiles('artifacts/VidFlowDesktop-v*-macOS-arm64/*.dmg') != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/VidFlowDesktop-v${{ env.VERSION }}-macOS-arm64/VidFlowDesktop-v${{ env.VERSION }}-macOS-arm64.dmg
          asset_name: VidFlowDesktop-v${{ env.VERSION }}-macOS-arm64.dmg
          asset_content_type: application/x-apple-diskimage

      - name: Upload macOS x86_64 Release Asset
        if: hashFiles('artifacts/VidFlowDesktop-v*-macOS-x86_64/*.dmg') != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/VidFlowDesktop-v${{ env.VERSION }}-macOS-x86_64/VidFlowDesktop-v${{ env.VERSION }}-macOS-x86_64.dmg
          asset_name: VidFlowDesktop-v${{ env.VERSION }}-macOS-x86_64.dmg
          asset_content_type: application/x-apple-diskimage